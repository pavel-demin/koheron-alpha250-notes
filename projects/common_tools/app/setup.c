#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <unistd.h>
#include <fcntl.h>
#include <sys/ioctl.h>
#include <linux/spi/spidev.h>

void setup_clock(const char *device)
{
  int i, fd, value;

  uint8_t data[100] =
  {
    0x00, 0x02, 0x00, 0x00,
    0x00, 0x00, 0x1f, 0x40,
    0x00, 0x00, 0x01, 0x41,
    0x00, 0x00, 0x01, 0x42,
    0x00, 0x00, 0x01, 0x43,
    0x80, 0x00, 0x1f, 0x44,
    0x80, 0x00, 0x1f, 0x45,
    0x01, 0x80, 0x00, 0x06,
    0x01, 0x10, 0x00, 0x07,
    0x01, 0x01, 0x00, 0x08,
    0x55, 0x55, 0x55, 0x49,
    0x18, 0x01, 0x42, 0x0a,
    0x04, 0x01, 0x10, 0x0b,
    0x1b, 0x0c, 0x01, 0x8c,
    0x23, 0x03, 0x24, 0xed,
    0x92, 0x00, 0x00, 0x0e,
    0x80, 0x00, 0x02, 0x0f,
    0x01, 0x55, 0x04, 0x10,
    0x00, 0x00, 0x00, 0xd8,
    0x01, 0x01, 0x00, 0x19,
    0xaf, 0xa8, 0x00, 0x1a,
    0x18, 0x00, 0x00, 0x5b,
    0x00, 0x20, 0x02, 0x9c,
    0x01, 0x00, 0x00, 0xbd,
    0x05, 0x00, 0x00, 0xbe
  };

  fd = open(device, O_RDWR);

  value = SPI_MODE_0;
  ioctl(fd, SPI_IOC_WR_MODE, &value);

  value = 8;
  ioctl(fd, SPI_IOC_WR_BITS_PER_WORD, &value);

  value = 10000000;
  ioctl(fd, SPI_IOC_WR_MAX_SPEED_HZ, &value);

  for(i = 0; i < 25; ++i)
  {
    write(fd, data + i * 4, 4);
  }

  close(fd);
}

void setup_adc(const char *device)
{
  int i, fd, value;

  uint8_t data[6] =
  {
    0x00, 0x80,
    0x03, 0x1e,
    0x04, 0x01
  };

  fd = open(device, O_RDWR);

  value = SPI_MODE_0;
  ioctl(fd, SPI_IOC_WR_MODE, &value);

  value = 8;
  ioctl(fd, SPI_IOC_WR_BITS_PER_WORD, &value);

  value = 10000000;
  ioctl(fd, SPI_IOC_WR_MAX_SPEED_HZ, &value);

  for(i = 0; i < 3; ++i)
  {
    write(fd, data + i * 2, 2);
  }

  close(fd);
}

int main()
{
  setup_clock("/dev/spidev0.0");

  setup_adc("/dev/spidev0.1");

  setup_adc("/dev/spidev0.2");

  return EXIT_SUCCESS;
}
